---
title: nginx配置
tags: nginx 运维
---
## 概述

```
main            #全局块
#pid /nginx/pid/nginx.pid;   #指定nginx进程运行文件存放地址
events {         #events块
}
http      #http块
{
    ...   #http全局块
    include mime.types ;//表示引人的 mime.types 文件是相对于当前配置文件nginx. conf 
    server        #server块
    { 
        ...       #server全局块
        location [PATTERN]   #location块
        {
            ...
        }
        location  ~*^.+$ {       #请求的url过滤，正则匹配，~为区分大小写，~*为不区分大小写。
           #root path;  #根目录
           #index vv.txt;  #设置默认页
           proxy_pass  http://mysvr;  #请求转向mysvr 定义的服务器列表
           deny 127.0.0.1;  #拒绝的ip
           allow 192.168.1.3; #允许的ip           
        }  
    }
}
1、全局块：配置影响nginx全局的指令;
2、events块：配置影响nginx服务器或与用户的网络连接。
   有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。
3、http块：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。
   如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。
4、server块：配置虚拟主机的相关参数，一个http中可以有多个server。
5、location块：配置请求的路由，以及各种页面的处理情况。
```
## 配置说明

```
如果你想通过http获取客户的真是ip而不是获取代理服务器的ip地址，那么要做如下的设置。
- proxy_set_header Host $host; 
  #只要用户在浏览器中访问的域名绑定了 VIP VIP 下面有RS；则就用$host ；host是访问URL中的域名和端口  www.taobao.com:80
- proxy_set_header X-Real-IP $remote_addr;  
  #把源IP 【$remote_addr,建立HTTP连接header里面的信息】赋值给X-Real-IP;这样在代码中 $X-Real-IP来获取 源IP
- proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #在nginx 作为代理服务器时，设置的IP列表，会把经过的机器ip，代理机器ip都记录下来，用 【，】隔开；
  #代码中用 echo $x-forwarded-for |awk -F, '{print $1}' 来作为源IP

- root /var/www/html
  定义服务器的默认网站根目录位置。如果locationURL匹配的是子目录或文件，root没什么作用，一般放在server指令里面或/下。
- index index.jsp index.html index.htm
  定义路径下默认访问的文件名，一般跟着root放
- proxy_pass http:/backend
  请求转向backend定义的服务器列表，即反向代理，对应upstream负载均衡器。也可以proxy_pass http://ip:port。
- 列出目录 autoindex
  Nginx默认是不允许列出整个目录的。如需此功能，打开nginx.conf文件，在location，server 或 http段中加入autoindex on;，
  另外两个参数最好也加上去,
   autoindex_exact_size off; 默认为on，显示出文件的确切大小，单位是bytes。
      改为off后，显示出文件的大概大小，单位是kB或者MB或者GB
   autoindex_localtime on;
      默认为off，显示的文件时间为GMT时间。改为on后，显示的文件时间为文件的服务器时间
```
## nginx负载均衡配置

```
down，表示当前的server暂时不参与负载均衡。

backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。

max_fails，允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误。

fail_timeout，在经历了max_fails次失败后，暂停服务的时间。max_fails可以和fail_timeout一起使用。

upstream mysvr { 
    server 127.0.0.1:7878 weight=2 max_fails=2 fail_timeout=2;
    server 192.168.10.121:3333 weight=1 max_fails=2 fail_timeout=1; 
    server 192.168.101.121 backup;       
}
```
## 用户和组
> Nginx 服务是由一个主进程( master process)和多个 工作进程( worker process)组成 的 。其 中，主进程以 root 权限运行，而 工 作进程在默认情况下以 nobody 用户运行 。原因在 于 nobody 用户是一个不能登录的账号，有一个专用的 ID，可将每个运行的工作进程隔离出 来，这样即使黑客破坏了服务器程序，因其不是 root 用户，也不会影响其他数据 。
因此，为工作进程设置的执行用户权限越低，则服务器安全系数越高 

## 访问控制

```
Nginx中提供了两个用于配置访问权限控制的指令，分别为 allow 和 deny。 
allow 用于设置允许访问的权限、 deny 用于设置禁止访问的权限。 
在使用时，权限指令后只需跟上允许或禁止的 P,IP 段或 all 即可 。 其中，all 表示所有的 。
需要特别注意以下几个点 ：
- 单个 IP 指定作用范围最小， all 指定作用范围最大 。
- 同一块下，若同时存在多个权限指令( deny、allow) ，则先出现的访问权限设 置生效，
  并且会对后出现的设置进行破盖，未覆盖的范围依然生效，否则以先出现的设置 为准 。
- 当多个块(如 http、server、location)中都出现了权限设置指令，则内层块中的权限级别要比外层块中设置的权限级别高 。
```
## location

```
location [=|~|~ *|^ ~] URI { ... }   #语法类型 1
location @name (... } #语法类型 2

前缀        说明
 =       根据其后的指定模式进行精准匹配
 ~       使用正则表达式完成 location 的匹配，区分大小写 
 ~*      使用正则表达式完成 location 的匹配，不区分大小写 
 ^~      不使用正则表达式，完成以指定模式开头的 location 匹配
 @       用于定义一个location 块，且该块不能被外部客户端所访问,只能被nginx内部配置指令所访问

 因此，当多种类型的 location 匹配同时出现时，最终执行结果为“ = ”匹配优先于“ ^~ ”匹配，
 “^~”匹配优先于正则匹配，正则匹配优先于普通的最大前缀匹配 。 只要优先的 location 匹配成功，就不会执行其他的 location
```
##  servername指令的使用

```
- 基于端口号配置虚拟主机
  listen 8001;

- 基于 IP配置虚拟主机
  listen 80;
  server name 192.168.78.4; 
- 基于域名配置虚拟主机
   #以*通配符开始的字符.
   server_name  *.test.com; 
   #以*通配符结束的字符串
   server_name  www.*;
   #匹配正则表达式
   server name ~^(?.+)\.domain\.com$ ;
   server_name 指令的几种设置方式，在使用中只要有一项匹配成功，则停止继续匹配其他设置。 
   且匹配的优先级顺序依次为，精准匹> 以通配符开始的字符串 〉 以通配符结束的字符串 〉 正则表达式 。
```
## root与alias

```
#收到”/img/itheima.png”请求时，将请求映射为"/var/www/image/itheima.png” 
location /img/ {
   alias /var/www/image/;
}
#收到”/img/itheima.png”请求时，将请求映射为"/var/www/image/img/itheima.png” 
location /img/ {
   root /var/www/image/;
}
```
## 子配置文件的引入

```
include file | mask;
在上述语法中， file 用于指定包含的文件名称， mask 用于指定某一路径下的文件，其路 径可以是相对路径，也可以是绝对路径 。
其中，在使用相对路径的情况下，相对的路径是 Nginx 的安装路径下的conf目录 /usr/ local/ nginx/ conf。

```
## 常用缓存配置指令

```
指令                               说 明
proxy_cache_bypass               用于配置 Nginx 向客户端发送响应数据时，不从缓存中获取的条件
proxy_cache_lock                 用于设置是否开启缓存的锁功能
proxy_cache_lock_timeout         用于设置缓存的锁功能开启以后锁的超时时间
proxy_no_cache                   配置在什么情况下不使用缓存功能
proxy_cache_min_uses             当同一个URL被重复请求达到指定的次数后，才对该URL进行缓存
proxy_cache_revalidate           用于当缓存内容过期时，Nginx 通过一次If-Modified-Since的请求头去验证缓存内容是否过期
proxy_cache_use_stale            设置状态，用于内容源Web服务器处于这些状态时， Nginx向客户端响应历史缓存数据

```
## 日志文件

```
 log_format指令进行自定义;
 存储路径、缓存大小等可使用access_log 指令设置。 
 通过访问日志的配置，可以记录用户 IP、访问时间、请求方式、响应状态、地域来源、跳转来源、使用终端等信息。

与日志格式相关的内置变量：
内置变量           说明
$remote_addr    客户端的 IP 地址
$remote user    客户端用户名，用于记 录浏览者进行身份验证时提供的名称，如果没有登录则为空
$time local     访问的时间与时区，如21/Sep/2016:12:21,25 +0800，时间信息最后的+0800表示服务器所处时区位于UTC 之后的8小时
$request        请求的 URI 和 HTTP 协议
$status         记录请求返回的 HTTP 状态码
$body_bytes_sent  发送给客户端的文件主体内容的大小
$http_referer    来路 URL 地址
$http_user_agent  客户端浏览器信息
$http_x_forwarded for 客户端 IP 地址列表(包括中间 经 过的代理 )

错误日志是由 error_log 指令设置的，主要是用来记录客户端在访问 Nginx 时出错的记 录，且该错误显示格式不支持自定义功能。
关闭访问日志：access_log off;
关闭错误日志：error_log /dev/null;
```
## 错误页面
- 自定义错误页面的大小必须大于512字节，否则错误页面的展示将使用 IE 默认的错误页面 。

```
errr_page 500 502 503 504 /50x.html;

1.为每种类型的错误设置单独的处理方式
#指定网站极目呆下的页商 40x.html，处琦 403错误
errr_page 403 /40x .html ; 
#指定网站根目录下的网片 404.j间，处理 404错误 
error_page 404 /404 . jpg;
2.利用在线资源进行处理错误
error_page 403 http://example.com/forbidden.html;
3.更改晌应状态码
要隐藏服务器返回的真实状态码信息，则可以利用=进行自定义设置，如：
error_page 404 =200 /40x .html;
在 发生 404 错误时，响应信息中的状态码是自定义的码值 200
另外，更改响应状态码时还可以不指定确切的码值，而是由重定向后实际处理的真实结果来决定 。 

error_page 404= / 40x .html ;
```
