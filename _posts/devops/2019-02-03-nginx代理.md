---
title: nginx代理
tags: nginx 运维
---
简单概括，正向代理是局域网内机器访问外网资源的中介，反向代理是外网机器访问局域网内的资源；

## 正向代理指令
- resolver address ... [valid=time] 用于指定dns服务器的ip地址； 
> address:dns的ip地址，不指定端口，默认使用53；
  time:设置数据包在网络中的有效时间；
- resolver_timeout time    dns解析超时时长； 
- proxy_pass url  设置代理服务器协议和地址； 
> 注意：1.正向代理可以加在http,server,location配置，但是一般在server中，
       注意在server中不要出现server_name指令，即不要设置虚拟主机的名称或ip;
       2.resolver指令是必须的，不然无法处理接收的域名；
       3.nginx不支持正向代理https站点；

```
server {
   resolver 6.6.6.6;
   listen 80;
   location / {
      proxy_pass http://$http_host$resuest_uri;
   }
}
```
## 反向代理

- proxy_pass url 被代理的服务器地址；还可以是服务器组，此时用的upstream;
>注意以下2种写法：

```
upstream serverlist{
   server http://192.168.1.2:8080/url/
   server http://192.168.1.3:8080/url/
}
server {
   location / {
      proxy_pass serverlist
   }
}

upstream serverlist{
   server 192.168.1.2:8080/url/
   server 192.168.1.3:8080/url/
}
server {
   location / {
      proxy_pass http://serverlist
   }
}
```
> url中是否包含uri，nginx处理方式是不同的；如果不包含，nginx不会改变原地址的uri，如果包含，
nginx会用新的uri替换原来的uri,所以如果不想改变原地址的uri，就不要再url变量中配置uri;
 
```
server_name www.web.com
location /server/{
 proxy_pass http://192.168.1.1  #1
 proxy_pass http://192.168.1.1/local  #2
}
请求是http://www.web.com/server,使用#1 ，nginx会把地址指向http://www.web.com/server;
使用#2，指向http://www.web.com/local

location /server/{
 proxy_pass http://192.168.1.1  #1  http://www.web.com/server/index
 proxy_pass http://192.168.1.1/  #2  http://www.web.com/index
}
```
- proxy_hide_header filed nginx发送响应是，隐藏指定头信息；
- proxy_pass_header filed 默认nginx在发送响应时，报文头不包含date,server等来自被代理服务器的头信息，该指令可以设置这些头信息被发送；
- proxy_pass_request_body on/off 是否将客户端的请求体发送给被代理服务器；
- proxy_pass_request_header on/off 是否将客户端的请求头发送给被代理服务器；
- proxy_set_header key value 更改客户端的头信息，将新的头信息发给被代理服务器；
```
  proxy_set_header Host $http_host   #host值填充为客户端的地址
  proxy_set_header Host $host  #host值填充为server_name的值
  proxy_set_header Host $proxy_host #host值填充为nginx的地址，默认值
``` 
